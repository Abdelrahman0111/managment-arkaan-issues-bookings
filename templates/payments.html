{% extends "base.html" %}

{% block content %}
<div class="content-card">
    <h2>ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h2>
    <h5 class="text-muted">ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</h5>
    
    {% if issues %}
    <div class="table-responsive mt-4">
        <table class="table table-striped table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th>
                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹</th>
                    <th>Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</th>
                    <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in issues %}
                <tr>
                    <td>{{ issue.agent_name }}</td>
                    <td>{{ issue.booking_number }}</td>
                    <td>{{ issue.discount }}</td>
                    <td>
                        <span class="badge {% if issue.payment_type == 'Ø¬Ø²Ø¦ÙŠ' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ issue.payment_type }}
                        </span>
                    </td>
                    <td>{{ issue.monthly_amount or '-' }}</td>
                    <td>{{ issue.paid_amount or 0 }}</td>
                    <td>{{ issue.remaining_amount or issue.discount }}</td>
                    <td>
                        <span class="badge {% if issue.payment_status == 'Ù…ÙƒØªÙ…Ù„' %}bg-success{% elif issue.payment_status == 'Ø¬Ø²Ø¦ÙŠ' %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ issue.payment_status or 'Ù„Ù… ÙŠØ¯ÙØ¹' }}
                        </span>
                    </td>
                    <td>
                        {% if issue.payment_status != 'Ù…ÙƒØªÙ…Ù„' %}
                        <button class="btn btn-sm btn-primary" onclick="recordPayment('{{ issue.booking_number }}', {{ issue.monthly_amount or issue.discount }})">
                            ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©
                        </button>
                        {% else %}
                        <span class="text-success">âœ… Ù…ÙƒØªÙ…Ù„</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
    </div>
    {% endif %}
</div>

<!-- Modal Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="payment_booking">
                <div class="mb-3">
                    <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" class="form-control" id="payment_amount" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitPayment()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let paymentModal;

document.addEventListener('DOMContentLoaded', function() {
    paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
});

function recordPayment(booking, amount) {
    document.getElementById('payment_booking').value = booking;
    document.getElementById('payment_amount').value = amount;
    paymentModal.show();
}

async function submitPayment() {
    const booking = document.getElementById('payment_booking').value;
    const amount = parseFloat(document.getElementById('payment_amount').value);
    
    const response = await fetch('/record_payment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({booking_number: booking, payment_amount: amount})
    });
    
    if (response.ok) {
        alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        location.reload();
    } else {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©');
    }
}
</script>
{% endblock %}
